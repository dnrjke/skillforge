# CLAUDE.md – 매핑 및 좌표 처리 가이드라인

## 1. 기본 원칙

- **이전 코드 우선 원칙**
  변환이나 리팩토링 과정에서 직관과 어긋나는 매핑이 발생할 경우, 반드시 이전 브랜치(JS)의 매핑 테이블을 그대로 유지한다.
  새로 해석하거나 임의로 오름차순 정렬하지 않는다.

- **사용자 알림 의무**
  기존 코드와 새 매핑 규칙이 충돌할 경우, 즉시 사용자에게 알리고 선택지를 요청한다.

- **오름차순 강박 금지**
  직관과 어긋나면 이전 코드 유지. 충돌 시 반드시 사용자에게 알림.

## 2. 좌표 체계 (2행 3열 그리드)

### 전장 그리드 레이아웃

```
        후열(좌)   중열(중)   전열(우)
        ────────   ────────   ────────
상단      후열1      중열1      전열1
        (x:120)    (x:260)    (x:400)

하단      후열2      중열2      전열2
        (x:150)    (x:290)    (x:430)
```

### FORMATION 인덱스 (BattleScene.js)

| 인덱스 | 위치 | X좌표 | Y좌표 | 설명 |
|--------|------|-------|-------|------|
| 0 | 후열1 | 120 | 200 | 후열 상단 |
| 1 | 후열2 | 150 | 380 | 후열 하단 |
| 2 | 중열1 | 260 | 220 | 중열 상단 |
| 3 | 중열2 | 290 | 400 | 중열 하단 |
| 4 | 전열1 | 400 | 240 | 전열 상단 |
| 5 | 전열2 | 430 | 420 | 전열 하단 |

### 파티 현황판 슬롯 (PartyStatusUI.js)

```
뒷줄 (후열 대응):          앞줄 (전열 대응):
┌─────────────────┐       ┌─────────────────┐
│ pos=2 (상단)    │       │ pos=5 (상단)    │
│ pos=1 (중앙)    │       │ pos=4 (중앙)    │
│ pos=0 (하단)    │       │ pos=3 (하단)    │
└─────────────────┘       └─────────────────┘
```

## 3. 3vs3 매핑 테이블

**ACTIVE_SLOTS = [1, 2, 4]** (후열2, 중열1, 전열1)

| 유닛 | FORMATION | 전장 위치 | 파티 pos | 파티 위치 |
|------|-----------|-----------|----------|-----------|
| [0]  | 1 (후열2) | 좌측 하단 | 1        | 뒷줄 중앙 |
| [1]  | 2 (중열1) | 중앙 상단 | 2        | 뒷줄 상단 |
| [2]  | 4 (전열1) | 우측 상단 | 4        | 앞줄 중앙 |

**이 매핑은 절대 변경하지 않는다.**

## 4. 관련 파일

- `src/autobattle/constants/FormationMapping.ts` - 매핑 상수 및 타입 정의
- `src/autobattle/scenes/BattleScene.js` - 전장 캐릭터 배치
- `src/autobattle/ui/PartyStatusUI.js` - 파티 현황판 UI

## 5. 검증 절차

- `FormationMapping.ts`의 `validateMapping()` 함수로 일관성 검증
- 변환 시 전장 좌표와 UI 좌표 비교하여 불일치 자동 감지
- 불일치 감지 시:
  1. 이전 코드 매핑을 유지한다.
  2. 사용자에게 알린다.
  3. 절대 임의로 수정하지 않는다.

## 6. 요약

- 오름차순 강박 금지
- 직관과 어긋나면 이전 코드 유지
- 충돌 시 반드시 사용자에게 알림
- 매핑 테이블을 주석으로 박아두고 모든 로직에서 준수
- `FormationMapping.ts`를 단일 진실 공급원(Single Source of Truth)으로 사용
