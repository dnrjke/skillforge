# CLAUDE.md – 매핑 및 좌표 처리 가이드라인

## 1. 기본 원칙

- **이전 코드 우선 원칙**
  변환이나 리팩토링 과정에서 직관과 어긋나는 매핑이 발생할 경우, 반드시 이전 브랜치(JS)의 매핑 테이블을 그대로 유지한다.
  새로 해석하거나 임의로 오름차순 정렬하지 않는다.

- **사용자 알림 의무**
  기존 코드와 새 매핑 규칙이 충돌할 경우, 즉시 사용자에게 알리고 선택지를 요청한다.

- **오름차순 강박 금지**
  직관과 어긋나면 이전 코드 유지. 충돌 시 반드시 사용자에게 알림.

## 2. 시각적 순서 012345 배치

전→중→후 순서로 화면을 읽을 때 인덱스 0,1,2,3,4,5가 순서대로 보이도록 좌표를 배치.

### 시각적 그리드 레이아웃

```
        시각 front   시각 mid    시각 back
        ──────────   ─────────   ──────────
상단     [0]후열1     [2]중열1     [4]전열1
         (x:400)      (x:260)      (x:120)

하단     [1]후열2     [3]중열2     [5]전열2
         (x:430)      (x:290)      (x:150)
```

### FORMATION 인덱스 (BattleScene.js) - 좌표 스왑 적용

| 인덱스 | 의미 | 시각 위치 | X좌표 | Y좌표 |
|--------|------|-----------|-------|-------|
| 0 | 후열1 | front-top | 400 | 240 |
| 1 | 후열2 | front-bottom | 430 | 420 |
| 2 | 중열1 | mid-top | 260 | 220 |
| 3 | 중열2 | mid-bottom | 290 | 400 |
| 4 | 전열1 | back-top | 120 | 200 |
| 5 | 전열2 | back-bottom | 150 | 380 |

### 파티 현황판 슬롯 (PartyStatusUI.js) - 251403→012345 변환

```
시각 front:          시각 mid:           시각 back:
┌───────────┐       ┌───────────┐       ┌───────────┐
│ pos=0     │       │ pos=2     │       │ pos=4     │
│ (후열1)   │       │ (중열1)   │       │ (전열1)   │
├───────────┤       ├───────────┤       ├───────────┤
│ pos=1     │       │ pos=3     │       │ pos=5     │
│ (후열2)   │       │ (중열2)   │       │ (전열2)   │
└───────────┘       └───────────┘       └───────────┘
```

## 3. 6슬롯 매핑 테이블

**ACTIVE_SLOTS = [0, 1, 2, 3, 4, 5]** (디버깅용 6슬롯)

| 인덱스 | 의미 | 시각 위치 | 파티 pos |
|--------|------|-----------|----------|
| [0] | 후열1 | front-top | 0 |
| [1] | 후열2 | front-bottom | 1 |
| [2] | 중열1 | mid-top | 2 |
| [3] | 중열2 | mid-bottom | 3 |
| [4] | 전열1 | back-top | 4 |
| [5] | 전열2 | back-bottom | 5 |

**시각적 순서 012345가 핵심: 화면에서 전→중→후 순서로 읽을 때 0,1,2,3,4,5**

## 4. 관련 파일

- `src/autobattle/constants/FormationMapping.ts` - 매핑 상수 및 타입 정의
- `src/autobattle/scenes/BattleScene.js` - 전장 캐릭터 배치
- `src/autobattle/ui/PartyStatusUI.js` - 파티 현황판 UI

## 5. 검증 절차

- `FormationMapping.ts`의 `validateMapping()` 함수로 일관성 검증
- 시각적 순서 012345 검증:
  - 후열(back) → 시각 front (pos 0,1)
  - 중열(middle) → 시각 mid (pos 2,3)
  - 전열(front) → 시각 back (pos 4,5)

## 6. 요약

- 오름차순 강박 금지
- 직관과 어긋나면 이전 코드 유지
- 충돌 시 반드시 사용자에게 알림
- 매핑 테이블을 주석으로 박아두고 모든 로직에서 준수
- `FormationMapping.ts`를 단일 진실 공급원(Single Source of Truth)으로 사용
- **시각적 순서 012345**: 화면에서 전→중→후로 읽을 때 인덱스 순서
