# CLAUDE.md – 매핑 및 좌표 처리 가이드라인

## 1. 기본 원칙

- **이전 코드 우선 원칙**
  변환이나 리팩토링 과정에서 직관과 어긋나는 매핑이 발생할 경우, 반드시 이전 브랜치(JS)의 매핑 테이블을 그대로 유지한다.
  새로 해석하거나 임의로 오름차순 정렬하지 않는다.

- **사용자 알림 의무**
  기존 코드와 새 매핑 규칙이 충돌할 경우, 즉시 사용자에게 알리고 선택지를 요청한다.

- **오름차순 강박 금지**
  직관과 어긋나면 이전 코드 유지. 충돌 시 반드시 사용자에게 알림.

## 2. UI와 전장의 시각적 각도 불일치 처리

### 현상
- **파티 현황판(UI)**: 우상향(+각도) 배치 - 전열로 갈수록 위로 올라감
- **전장(Battlefield)**: 우하향(-각도) 배치 - 전열로 갈수록 아래로 내려감

### 처리 원칙
1. Y축 좌표의 **'증감 방향'**만 일치시킨다. (Y값이 커지면 전장에서도 아래, UI에서도 아래)
2. '상단(Top)' 키워드는 전장과 UI 모두에서 상대적으로 **작은 Y값/Top값**을 의미한다.
3. 시각적으로 UI는 위로 가고 유닛은 아래로 가더라도, 로직상으로는 **[작은 Y = 상단 / 큰 Y = 하단]** 공식을 절대 고수한다.

### 픽셀 대응표
| 위치 | 전장 좌표 (Y값) | UI 좌표 (Top값) | 인지적 위치 |
|------|----------------|-----------------|-------------|
| 상단(Top) | 200~240 (작음) | -20px ~ -5px (작음) | 안쪽 레인 |
| 하단(Bottom) | 380~420 (큼) | 10px ~ 32px (큼) | 바깥쪽 레인 |

## 3. 시각적 순서 012345 배치

전→중→후 순서로 화면을 읽을 때 인덱스 0,1,2,3,4,5가 순서대로 보이도록 배치.

### 전장 그리드 레이아웃 (BattleScene.js)

```
        시각 front   시각 mid    시각 back
        ──────────   ─────────   ──────────
상단     [0]후열1     [2]중열1     [4]전열1
         (x:400)      (x:260)      (x:120)

하단     [1]후열2     [3]중열2     [5]전열2
         (x:430)      (x:290)      (x:150)
```

### FORMATION 인덱스 - 좌표 스왑 적용

| 인덱스 | 의미 | 시각 위치 | X좌표 | Y좌표 |
|--------|------|-----------|-------|-------|
| 0 | 후열1 | front-top | 400 | 240 |
| 1 | 후열2 | front-bottom | 430 | 420 |
| 2 | 중열1 | mid-top | 260 | 220 |
| 3 | 중열2 | mid-bottom | 290 | 400 |
| 4 | 전열1 | back-top | 120 | 200 |
| 5 | 전열2 | back-bottom | 150 | 380 |

### 파티 현황판 슬롯 (PartyStatusUI.js)

**실제 CSS 시각 순서**: pos2 → pos5 → pos1 → pos4 → pos0 → pos3

**UNIT_TO_PARTY_SLOT 매핑**: [2, 5, 1, 4, 0, 3]
- 유닛0 → pos2 (시각1)
- 유닛1 → pos5 (시각2)
- 유닛2 → pos1 (시각3)
- 유닛3 → pos4 (시각4)
- 유닛4 → pos0 (시각5)
- 유닛5 → pos3 (시각6)

## 4. 6슬롯 매핑 테이블

**ACTIVE_SLOTS = [0, 1, 2, 3, 4, 5]** (디버깅용 6슬롯)

| 유닛 인덱스 | 의미 | 전장 시각 위치 | 파티 pos | 파티 시각 순서 |
|-------------|------|----------------|----------|----------------|
| [0] | 후열1 | front-top | 2 | 시각1 |
| [1] | 후열2 | front-bottom | 5 | 시각2 |
| [2] | 중열1 | mid-top | 1 | 시각3 |
| [3] | 중열2 | mid-bottom | 4 | 시각4 |
| [4] | 전열1 | back-top | 0 | 시각5 |
| [5] | 전열2 | back-bottom | 3 | 시각6 |

**시각적 순서 012345가 핵심: 화면에서 전→중→후 순서로 읽을 때 0,1,2,3,4,5**

## 5. 관련 파일

- `src/autobattle/constants/FormationMapping.ts` - 매핑 상수 및 타입 정의 (단일 진실 공급원)
- `src/autobattle/scenes/BattleScene.js` - 전장 캐릭터 배치
- `src/autobattle/ui/PartyStatusUI.js` - 파티 현황판 UI

## 6. 검증 절차

- `FormationMapping.ts`의 `validateMapping()` 함수로 일관성 검증
- 디버그 라벨 `[인덱스] pN` 형식으로 시각 확인

## 7. 요약

- 오름차순 강박 금지
- 직관과 어긋나면 이전 코드 유지
- 충돌 시 반드시 사용자에게 알림
- 매핑 테이블을 주석으로 박아두고 모든 로직에서 준수
- `FormationMapping.ts`를 단일 진실 공급원(Single Source of Truth)으로 사용
- **시각적 순서 012345**: 화면에서 전→중→후로 읽을 때 인덱스 순서
- **각도 불일치**: UI는 우상향, 전장은 우하향 - Y값 증감 방향으로 통일
